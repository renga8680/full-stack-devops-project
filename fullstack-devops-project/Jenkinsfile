pipeline {
    agent any

    environment {
        SERVER_IP = "20.211.96.17"
        PROJECT_DIR = "fullstack-devops-project"
    }

    stages {

        stage('Checkout Code') {
            steps {
                echo 'üì• Pulling code from GitHub...'
                checkout scm
            }
        }

        stage('Verify Tools') {
            steps {
                echo 'üîç Checking Docker tools...'
                sh 'docker --version'
                sh 'docker compose version'
            }
        }

        stage('Build Images') {
            steps {
                echo 'üî® Building Docker images...'
                dir("${PROJECT_DIR}") {
                    sh 'docker compose build --no-cache'
                }
            }
        }

        stage('Stop Old Containers') {
            steps {
                echo 'üõë Stopping old containers (if any)...'
                dir("${PROJECT_DIR}") {
                    sh 'docker compose down || true'
                }
            }
        }

        stage('Deploy Application') {
            steps {
                echo 'üöÄ Starting containers...'
                dir("${PROJECT_DIR}") {
                    sh 'docker compose up -d'
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                echo '‚è≥ Waiting for services to initialize...'
                sh 'sleep 20'

                echo 'üì¶ Running containers:'
                sh 'docker ps'

                echo 'ü©∫ Performing backend health check...'

                sh '''
                    for i in {1..10}; do
                        if curl -f http://$SERVER_IP:5000/api/health; then
                            echo "‚úÖ Backend is healthy!"
                            exit 0
                        fi
                        echo "‚åõ Attempt $i/10 failed. Retrying in 5 seconds..."
                        sleep 5
                    done

                    echo "‚ùå Backend health check FAILED after multiple attempts."
                    exit 1
                '''
            }
        }
    }

    post {

        success {
            echo """
            ‚úÖ DEPLOYMENT SUCCESSFUL!
            ==========================================
            Frontend : http://${SERVER_IP}
            Backend  : http://${SERVER_IP}:5000/api/health
            Jenkins  : http://${SERVER_IP}:8080
            ==========================================
            """
        }

        failure {
            echo '‚ùå Deployment failed! Displaying container logs...'
            dir("${PROJECT_DIR}") {
                sh 'docker compose logs || true'
            }
        }

        always {
            echo 'üßπ Cleaning unused Docker resources...'
            sh 'docker system prune -f || true'
        }
    }
}
