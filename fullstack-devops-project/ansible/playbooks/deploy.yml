---
- name: Deploy Full Stack Application
  hosts: webservers
  become: yes
  
  vars:
    app_dir: /opt/fullstack-app
    docker_registry: your-registry.azurecr.io
    backend_image: "{{ docker_registry }}/backend"
    frontend_image: "{{ docker_registry }}/frontend"
    image_tag: "{{ lookup('env', 'BUILD_NUMBER') | default('latest') }}"
  
  tasks:
    - name: Ensure app directory exists
      file:
        path: "{{ app_dir }}"
        state: directory
        mode: '0755'
    
    - name: Copy docker-compose file
      template:
        src: ../templates/docker-compose.yml.j2
        dest: "{{ app_dir }}/docker-compose.yml"
    
    - name: Stop existing containers
      shell: |
        cd {{ app_dir }}
        docker-compose down || true
      ignore_errors: yes
    
    - name: Pull latest images
      shell: |
        docker pull {{ backend_image }}:{{ image_tag }}
        docker pull {{ frontend_image }}:{{ image_tag }}
      when: docker_registry is defined
    
    - name: Start application
      shell: |
        cd {{ app_dir }}
        docker-compose up -d
    
    - name: Wait for backend to be healthy
      uri:
        url: http://localhost:5000/api/health
        status_code: 200
      register: result
      until: result.status == 200
      retries: 12
      delay: 5
    
    - name: Verify frontend is accessible
      uri:
        url: http://localhost:80
        status_code: 200
      register: frontend_check
      until: frontend_check.status == 200
      retries: 12
      delay: 5
    
    - name: Display deployment status
      debug:
        msg: "Application deployed successfully!"
